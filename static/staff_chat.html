<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Operations AI - ClinicConnect</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: 'inherit',
                                a: {
                                    color: '#3182ce',
                                    '&:hover': {
                                        color: '#2c5282',
                                    },
                                },
                                p: {
                                    marginTop: '0.5em',
                                    marginBottom: '0.5em',
                                },
                                'ul > li': {
                                    marginTop: '0.25em',
                                    marginBottom: '0.25em',
                                },
                            },
                        },
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                        sidebar: {
                            DEFAULT: "hsl(var(--sidebar))",
                            foreground: "hsl(var(--sidebar-foreground))",
                            primary: "hsl(var(--sidebar-primary))",
                            "primary-foreground": "hsl(var(--sidebar-primary-foreground))",
                            accent: "hsl(var(--sidebar-accent))",
                            "accent-foreground": "hsl(var(--sidebar-accent-foreground))",
                            border: "hsl(var(--sidebar-border))",
                            ring: "hsl(var(--sidebar-ring))",
                        },
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
            --sidebar: 210 40% 98%;
            --sidebar-foreground: 222.2 84% 4.9%;
            --sidebar-primary: 221.2 83.2% 53.3%;
            --sidebar-primary-foreground: 210 40% 98%;
            --sidebar-accent: 210 40% 96.1%;
            --sidebar-accent-foreground: 222.2 84% 4.9%;
            --sidebar-border: 214.3 31.8% 91.4%;
            --sidebar-ring: 217.2 91.2% 59.8%;
        }
    </style>
</head>
<body class="bg-background text-foreground font-sans antialiased h-screen flex overflow-hidden animate-fade-in">

    <!-- Sidebar -->
    <aside class="hidden md:flex w-64 lg:w-72 border-r border-border bg-sidebar flex-col">
        <div class="p-4 border-b border-sidebar-border">
            <button onclick="window.location.href='dashboard.html'" class="flex items-center gap-2 text-sidebar-foreground hover:text-sidebar-primary transition-colors w-full">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                <span class="font-medium">Back to Dashboard</span>
            </button>
        </div>

        <div class="p-4 border-b border-sidebar-border space-y-2">
            <button onclick="clearChat()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-11 px-8 w-full justify-start gap-2">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                New Conversation
            </button>
            <button onclick="window.location.href='dashboard.html'" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-11 px-8 w-full justify-start gap-2 bg-transparent">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                View Dashboard
            </button>
        </div>

        <div class="flex-1 overflow-y-auto">
            <div class="p-4 space-y-2">
                <h3 class="text-xs font-semibold text-sidebar-foreground/60 uppercase tracking-wider mb-3">History</h3>
                <div id="historyList">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-sidebar-border">
            <div class="flex items-center gap-3 mb-3">
                <div class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
                    <div class="flex h-full w-full items-center justify-center rounded-full bg-primary text-primary-foreground">ST</div>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-sidebar-foreground" id="sidebar-user-name">Staff Account</p>
                    <p class="text-xs text-sidebar-foreground/60" id="sidebar-user-email">staff@clinic.com</p>
                </div>
            </div>
            <button onclick="window.location.href='main_page.html'" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3 w-full bg-transparent">
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col h-full">
        <!-- Header -->
        <header class="border-b border-border bg-card p-4 shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='dashboard.html'" class="md:hidden p-2 hover:bg-secondary rounded-lg transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-primary to-accent rounded-lg flex items-center justify-center">
                            <i data-lucide="sparkles" class="w-5 h-5 text-primary-foreground"></i>
                        </div>
                        <div>
                            <h1 class="font-semibold text-foreground">AI Operations Assistant</h1>
                            <p class="text-xs text-muted-foreground">Staff-only support system</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4">
            <div class="max-w-3xl mx-auto h-full">
                <div id="emptyState" class="flex flex-col items-center justify-center h-full min-h-[400px] text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-primary/20 to-accent/20 rounded-3xl flex items-center justify-center mb-6 shadow-lg">
                        <i data-lucide="sparkles" class="w-10 h-10 text-primary"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-foreground mb-3">Welcome to Operations AI</h2>
                    <p class="text-muted-foreground mb-8 max-w-md leading-relaxed">
                        I can help with SOPs, patient management, scheduling, and clinic operations. What do you need help with?
                    </p>

                    <div class="grid sm:grid-cols-2 gap-3 w-full max-w-2xl">
                        <button onclick="sendSuggestion('SOP: Handling emergency triage')" class="p-5 text-left bg-card border border-border rounded-xl hover:border-primary hover:bg-primary/5 hover:scale-105 transition-all group shadow-sm">
                            <p class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">SOP: Handling emergency triage</p>
                        </button>
                        <button onclick="sendSuggestion('Update opening hours')" class="p-5 text-left bg-card border border-border rounded-xl hover:border-primary hover:bg-primary/5 hover:scale-105 transition-all group shadow-sm">
                            <p class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">Update opening hours</p>
                        </button>
                        <button onclick="sendSuggestion('How to manage patient records?')" class="p-5 text-left bg-card border border-border rounded-xl hover:border-primary hover:bg-primary/5 hover:scale-105 transition-all group shadow-sm">
                            <p class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">How to manage patient records?</p>
                        </button>
                        <button onclick="sendSuggestion('Generate appointment summary')" class="p-5 text-left bg-card border border-border rounded-xl hover:border-primary hover:bg-primary/5 hover:scale-105 transition-all group shadow-sm">
                            <p class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">Generate appointment summary</p>
                        </button>
                    </div>
                </div>
                
                <div id="messageList" class="space-y-6 py-4 hidden">
                    <!-- Messages will be injected here -->
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-border bg-card p-4 shrink-0">
            <div class="max-w-3xl mx-auto">
                <div class="flex gap-2">
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileUpload(this)">
                    <button onclick="document.getElementById('fileInput').click()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10 flex-shrink-0" title="Upload File">
                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                    </button>
                    <input id="chatInput" type="text" placeholder="Ask about operations, SOPs, or scheduling..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 flex-1">
                    <button onclick="sendMessage()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 w-10 flex-shrink-0 shadow-lg">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <p class="text-xs text-muted-foreground mt-2 text-center">
                    Staff-only AI Assistant for clinic operations
                </p>
            </div>
        </div>
    </main>

    <script>
        // Session Management
        let sessions = JSON.parse(localStorage.getItem('staffSessions') || '[]');
        let sessionId = localStorage.getItem('staffSessionId');

        // Initialize if no sessions or no current session
        if (!sessionId) {
            initNewSession();
        }

        function initNewSession() {
            sessionId = 'staff_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('staffSessionId', sessionId);
            messages = [];
            renderMessages();
            renderHistoryList();
        }

        // Render Sidebar History
        function renderHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = sessions.map(session => `
                <button onclick="switchSession('${session.id}')" class="w-full text-left p-3 rounded-lg transition-colors group ${session.id === sessionId ? 'bg-sidebar-accent text-sidebar-primary' : 'hover:bg-sidebar-accent'}">
                    <div class="flex items-start gap-2">
                        <i data-lucide="message-square" class="w-4 h-4 ${session.id === sessionId ? 'text-sidebar-primary' : 'text-sidebar-foreground/60'} mt-0.5 flex-shrink-0"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm ${session.id === sessionId ? 'font-medium' : 'text-sidebar-foreground'} truncate">
                                ${session.title}
                            </p>
                            <p class="text-xs text-sidebar-foreground/50 mt-1">${new Date(session.timestamp).toLocaleDateString()}</p>
                        </div>
                    </div>
                </button>
            `).join('');
            lucide.createIcons();
        }

        async function switchSession(id) {
            if (id === sessionId) return;
            console.log("Switching to session:", id);
            sessionId = id;
            localStorage.setItem('staffSessionId', sessionId);
            renderHistoryList(); // Update active state
            await loadHistory();
        }

        // Load Chat History
        async function loadHistory() {
            messages = []; // Clear current messages
            
            // Show loading state
            const messageList = document.getElementById('messageList');
            const emptyState = document.getElementById('emptyState');
            
            emptyState.classList.add('hidden');
            messageList.classList.remove('hidden');
            messageList.innerHTML = `
                <div class="flex justify-center items-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
            `;

            try {
                const response = await fetch(`/api/history?sessionId=${sessionId}`);
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    messages = data.history.map(msg => ({
                        ...msg,
                        timestamp: new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    }));
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
            
            renderMessages();
        }

        // Chat Logic
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const messageList = document.getElementById('messageList');
        const chatInput = document.getElementById('chatInput');

        let messages = [];

        function renderMessages() {
            if (messages.length === 0) {
                emptyState.classList.remove('hidden');
                messageList.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                messageList.classList.remove('hidden');
                
                messageList.innerHTML = messages.map(msg => `
                    <div class="flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        ${msg.role === 'assistant' ? `
                            <div class="relative flex h-8 w-8 shrink-0 overflow-hidden rounded-full">
                                <div class="flex h-full w-full items-center justify-center rounded-full bg-gradient-to-br from-primary to-accent text-primary-foreground">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                </div>
                            </div>
                        ` : ''}
                        <div class="max-w-[70%] rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-primary text-primary-foreground shadow-lg' : 'bg-card border border-border text-card-foreground shadow-sm'}">
                            <div class="text-sm leading-relaxed prose ${msg.role === 'user' ? 'prose-invert' : ''} max-w-none">
                                ${msg.role === 'assistant' ? marked.parse(msg.content) : msg.content}
                            </div>
                            <p class="text-xs mt-2 ${msg.role === 'user' ? 'text-primary-foreground/70' : 'text-muted-foreground'}">${msg.timestamp}</p>
                        </div>
                        ${msg.role === 'user' ? `
                            <div class="relative flex h-8 w-8 shrink-0 overflow-hidden rounded-full">
                                <div class="flex h-full w-full items-center justify-center rounded-full bg-secondary text-secondary-foreground">
                                    <i data-lucide="user" class="w-4 h-4"></i>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                lucide.createIcons();
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Add to sessions list if not present (first message)
            let currentSession = sessions.find(s => s.id === sessionId);
            if (!currentSession) {
                currentSession = {
                    id: sessionId,
                    title: text.substring(0, 25) + (text.length > 25 ? '...' : ''),
                    timestamp: new Date().toISOString()
                };
                sessions.unshift(currentSession);
                localStorage.setItem('staffSessions', JSON.stringify(sessions));
                renderHistoryList();
            } else if (currentSession.title === 'New Conversation') {
                // Update title if it was generic
                currentSession.title = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                localStorage.setItem('staffSessions', JSON.stringify(sessions));
                renderHistoryList();
            }

            const userMsg = {
                id: Date.now(),
                role: 'user',
                content: text,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            messages.push(userMsg);
            chatInput.value = '';
            renderMessages();

            // Get user email if logged in
            const userStr = localStorage.getItem('user');
            let userEmail = null;
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    userEmail = user.email;
                } catch (e) {
                    console.error("Error parsing user data", e);
                }
            }

            // Call API
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: text,
                        context: 'Staff',
                        sessionId: sessionId,
                        userEmail: userEmail
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                const aiMsg = {
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: data.response,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                messages.push(aiMsg);
                renderMessages();

            } catch (error) {
                console.error('Error:', error);
                const errorMsg = {
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: "Sorry, I'm having trouble connecting to the server. Please try again later.",
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                messages.push(errorMsg);
                renderMessages();
            }
        }

        function sendSuggestion(text) {
            chatInput.value = text;
            sendMessage();
        }

        function clearChat() {
            initNewSession();
            messages = [];
            renderMessages();
        }

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize
        lucide.createIcons();
        renderHistoryList();
        loadHistory();
        loadUserInfo();

        function loadUserInfo() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const email = user.email || 'Staff';
                    
                    // Update Sidebar
                    const sidebarName = document.getElementById('sidebar-user-name');
                    const sidebarEmail = document.getElementById('sidebar-user-email');
                    if (sidebarName) sidebarName.textContent = email;
                    if (sidebarEmail) sidebarEmail.textContent = email;
                    
                    // Update Avatar Initials
                    const initials = email.substring(0, 2).toUpperCase();
                    const avatars = document.querySelectorAll('.rounded-full.bg-primary.text-primary-foreground');
                    avatars.forEach(avatar => {
                        if (avatar.textContent === 'ST') avatar.textContent = initials;
                    });

                } catch (e) {
                    console.error("Error parsing user data", e);
                }
            }
        }

        async function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Show uploading state
                const loadingMsgId = Date.now();
                const loadingMsg = {
                    id: loadingMsgId,
                    role: 'assistant',
                    content: `Uploading ${file.name}...`,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                messages.push(loadingMsg);
                renderMessages();

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    // Remove loading message
                    messages = messages.filter(m => m.id !== loadingMsgId);
                    
                    if (data.success) {
                        // Add success message
                        const successMsg = {
                            id: Date.now(),
                            role: 'assistant',
                            content: `✅ Successfully uploaded **${file.name}**. I can now answer questions about it.`,
                            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        };
                        messages.push(successMsg);
                    } else {
                        throw new Error(data.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    // Remove loading message
                    messages = messages.filter(m => m.id !== loadingMsgId);
                    
                    const errorMsg = {
                        id: Date.now(),
                        role: 'assistant',
                        content: `❌ Failed to upload ${file.name}: ${error.message}`,
                        timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };
                    messages.push(errorMsg);
                }
                
                renderMessages();
                input.value = ''; // Reset
            }
        }
    </script>
</body>
</html>